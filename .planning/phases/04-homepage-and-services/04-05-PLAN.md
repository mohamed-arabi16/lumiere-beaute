---
phase: 04-homepage-and-services
plan: "05"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/components/sections/CategoryTabs.tsx
  - src/components/sections/TreatmentGrid.tsx
  - src/pages/ServicesPage.tsx
autonomous: true
requirements:
  - SRVC-01
  - SRVC-02

must_haves:
  truths:
    - "Clicking a category tab on the Services page filters the visible treatment cards to only that category, and an animated underline indicator slides to the active tab"
    - "All 20+ treatments are accessible — each category shows its treatments when its tab is selected"
    - "Each treatment card displays treatment name, description, duration, and price"
    - "Switching categories animates cards out (exit) and in (enter) — removed cards animate exit before new ones appear"
    - "The LayoutGroup id='services-category-tabs' scopes the layoutId so it cannot leak to other pages during page transitions"
  artifacts:
    - path: "src/components/sections/CategoryTabs.tsx"
      provides: "Animated tab bar with sliding underline indicator for category filtering"
      exports: ["CategoryTabs"]
    - path: "src/components/sections/TreatmentGrid.tsx"
      provides: "AnimatePresence grid of treatment cards that animate on category filter change"
      exports: ["TreatmentGrid"]
    - path: "src/pages/ServicesPage.tsx"
      provides: "Complete services page replacing Phase 2 stub: hero, CategoryTabs, TreatmentGrid"
      exports: ["ServicesPage"]
  key_links:
    - from: "src/components/sections/CategoryTabs.tsx"
      to: "framer-motion LayoutGroup + layoutId"
      via: "<LayoutGroup id='services-category-tabs'> wrapping tabs; layoutId='active-tab-indicator' on the active indicator motion.div"
      pattern: "LayoutGroup|layoutId"
    - from: "src/components/sections/TreatmentGrid.tsx"
      to: "framer-motion AnimatePresence"
      via: "<AnimatePresence mode='popLayout'> wrapping filtered treatment list"
      pattern: "AnimatePresence.*popLayout"
    - from: "src/pages/ServicesPage.tsx"
      to: "src/components/sections/CategoryTabs.tsx"
      via: "import { CategoryTabs } from '../components/sections/CategoryTabs'; activeCategory state passed as prop"
      pattern: "CategoryTabs"
    - from: "src/pages/ServicesPage.tsx"
      to: "src/types/content.ts"
      via: "import type { Treatment, Category } from '../../types/content' — via CategoryTabs and TreatmentGrid props"
      pattern: "Category|Treatment"
---

<objective>
Build CategoryTabs (animated tab filter) and TreatmentGrid (AnimatePresence card grid), then replace the Phase 2 stub ServicesPage.tsx with the complete services page.

Purpose: The services page is the highest-complexity page in Phase 4 due to the category filter with AnimatePresence exit animations and LayoutGroup-scoped layoutId tab indicator. Building CategoryTabs and TreatmentGrid as separate components keeps ServicesPage.tsx clean and each component independently testable.

Output: src/components/sections/CategoryTabs.tsx, TreatmentGrid.tsx, src/pages/ServicesPage.tsx
</objective>

<execution_context>
@/Users/mohamedkhair/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mohamedkhair/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-homepage-and-services/04-RESEARCH.md
@.planning/phases/04-homepage-and-services/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build CategoryTabs and TreatmentGrid components</name>
  <files>
    src/components/sections/CategoryTabs.tsx
    src/components/sections/TreatmentGrid.tsx
  </files>
  <action>
**CategoryTabs.tsx:**

```typescript
import { motion, LayoutGroup } from 'framer-motion';
import { useTranslation } from 'react-i18next';
import type { Category } from '../../types/content';
import { BodyText } from '../ui/Typography';

interface CategoryTabsProps {
  categories: Category[];
  activeCategory: string;
  onSelect: (id: string) => void;
}

export function CategoryTabs({ categories, activeCategory, onSelect }: CategoryTabsProps) {
  const { t } = useTranslation('common');

  return (
    <LayoutGroup id="services-category-tabs">
      <div
        role="tablist"
        aria-label={t('services.hero.headline')}
        className="flex gap-1 flex-wrap"
      >
        {categories.map((cat) => (
          <motion.button
            key={cat.id}
            role="tab"
            aria-selected={activeCategory === cat.id}
            onClick={() => onSelect(cat.id)}
            className={[
              'relative py-2 ps-4 pe-4 font-body text-sm transition-colors duration-200',
              'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-seagrass-500 rounded-sm',
              activeCategory === cat.id
                ? 'text-stormy-teal-950 dark:text-celadon-100 font-medium'
                : 'text-jungle-teal-700 dark:text-mint-leaf-400 hover:text-seagrass-600 dark:hover:text-seagrass-300',
            ]
              .filter(Boolean)
              .join(' ')}
          >
            {cat.label}
            {activeCategory === cat.id && (
              <motion.div
                layoutId="active-tab-indicator"
                className="absolute inset-x-0 bottom-0 h-0.5 bg-seagrass-600 dark:bg-seagrass-400"
              />
            )}
          </motion.button>
        ))}
      </div>
    </LayoutGroup>
  );
}
```

**Key notes:**
- `LayoutGroup id="services-category-tabs"` is REQUIRED — scopes the layoutId to prevent leaking to other pages during AnimatePresence transitions (Pitfall 6 from research)
- `ps-4 pe-4` logical padding — no pl-/pr- (locked decision)
- `aria-selected` boolean on each tab button for accessibility
- The active indicator `motion.div` with `layoutId="active-tab-indicator"` slides between tabs via Framer Motion's layout animation — no manual offset calculation needed

---

**TreatmentGrid.tsx:**

```typescript
import { motion, AnimatePresence } from 'framer-motion';
import type { Treatment } from '../../types/content';
import { Card } from '../ui/Card';
import { Heading, BodyText } from '../ui/Typography';

interface TreatmentGridProps {
  treatments: Treatment[];
}

export function TreatmentGrid({ treatments }: TreatmentGridProps) {
  return (
    <div className="mt-8">
      <AnimatePresence mode="popLayout">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {treatments.map((treatment) => (
            <motion.div
              key={treatment.id}
              layout
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.95 }}
              transition={{
                duration: 0.25,
                ease: [0.22, 1, 0.36, 1] as [number, number, number, number],
              }}
            >
              <Card hasPlaceholder={false} className="h-full flex flex-col gap-3">
                <Heading level={3} className="text-stormy-teal-950 dark:text-celadon-100">
                  {treatment.name}
                </Heading>
                <BodyText size="sm" className="text-jungle-teal-700 dark:text-mint-leaf-400 flex-grow">
                  {treatment.description}
                </BodyText>
                <div className="flex items-center justify-between gap-4 pt-2 border-t border-seagrass-200 dark:border-seagrass-700">
                  <BodyText size="sm" className="text-seagrass-600 dark:text-seagrass-400 font-medium">
                    {treatment.duration}
                  </BodyText>
                  <BodyText size="sm" className="text-stormy-teal-950 dark:text-celadon-100 font-semibold font-display">
                    {treatment.price}
                  </BodyText>
                </div>
              </Card>
            </motion.div>
          ))}
        </div>
      </AnimatePresence>
    </div>
  );
}
```

**Key notes:**
- `AnimatePresence mode="popLayout"` removes exiting cards from layout flow immediately — prevents remaining cards from snapping (Pitfall 5)
- `layout` prop on each `motion.div` — enables smooth repositioning of cards that stay in the list
- `ease: [0.22, 1, 0.36, 1] as [number, number, number, number]` — mandatory tuple cast for framer-motion v12 TypeScript strictness (same as Phase 2 decision)
- `treatment.id` as React key (stable string like "hydra-facial") — NEVER array index (Pitfall 3: prevents AnimatePresence key collision)
- `AnimatePresence` wraps the `treatments.map()` — the grid `div` is INSIDE AnimatePresence, not the container (pattern from research Pattern 3)

**WARNING:** DO NOT place `AnimatePresence` around the wrapping `<div className="mt-8">` — it must wrap only the items inside the grid.
  </action>
  <verify>npx tsc --noEmit from /Users/mohamedkhair/Coding/lumiere-beaute exits with code 0</verify>
  <done>CategoryTabs.tsx exports CategoryTabs with LayoutGroup id scoping and layoutId underline indicator; TreatmentGrid.tsx exports TreatmentGrid with AnimatePresence mode="popLayout" and layout prop on motion.div wrappers; both compile with zero TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Replace Phase 2 stub with full ServicesPage</name>
  <files>src/pages/ServicesPage.tsx</files>
  <action>
Replace the Phase 2 stub in src/pages/ServicesPage.tsx entirely.

The Phase 2 stub content (`Phase 2 stub — content coming in Phase 4`) must be completely removed.

**New ServicesPage.tsx:**

```tsx
import { useState } from 'react';
import { motion } from 'framer-motion';
import { useTranslation } from 'react-i18next';
import type { Category, Treatment } from '../types/content';
import { useDirection } from '../hooks/useDirection';
import { pageTransitionVariants } from '../animations/variants';
import { FadeInSection } from '../components/animations/FadeInSection';
import { Heading, BodyText } from '../components/ui/Typography';
import { CategoryTabs } from '../components/sections/CategoryTabs';
import { TreatmentGrid } from '../components/sections/TreatmentGrid';

export function ServicesPage() {
  const { t } = useTranslation('common');
  const { dir } = useDirection();

  const categories = t('services.categories', { returnObjects: true }) as Category[];
  const allTreatments = t('services.treatments', { returnObjects: true }) as Treatment[];

  const [activeCategory, setActiveCategory] = useState<string>(
    () => categories[0]?.id ?? 'facial'
  );

  const filteredTreatments = allTreatments.filter(
    (treatment) => treatment.category === activeCategory
  );

  return (
    <motion.div
      custom={dir}
      variants={pageTransitionVariants}
      initial="initial"
      animate="animate"
      exit="exit"
      className="min-h-screen"
    >
      {/* Page hero */}
      <FadeInSection className="py-20 px-6 text-center">
        <Heading level={1} className="text-stormy-teal-950 dark:text-celadon-100">
          {t('services.hero.headline')}
        </Heading>
        <BodyText size="lg" className="mt-4 text-jungle-teal-700 dark:text-mint-leaf-300 max-w-2xl mx-auto">
          {t('services.hero.subtitle')}
        </BodyText>
      </FadeInSection>

      {/* Category filter + treatment grid */}
      <div className="px-6 pb-20 max-w-7xl mx-auto">
        <CategoryTabs
          categories={categories}
          activeCategory={activeCategory}
          onSelect={setActiveCategory}
        />
        <TreatmentGrid treatments={filteredTreatments} />
      </div>
    </motion.div>
  );
}
```

**Critical architecture notes:**
- `useState` lazy initializer `() => categories[0]?.id ?? 'facial'` — reads initial category from locale data at mount time. The `?? 'facial'` fallback handles the unlikely case where locale array is empty.
- `filteredTreatments` is recomputed on every `activeCategory` state change — this is the correct pattern (no useMemo needed for 20 items)
- Page transition `motion.div` wrapper with `custom={dir}` is PRESERVED — same as Phase 2 page stub pattern (locked decision 02-03)
- `t('services.categories', { returnObjects: true }) as Category[]` — always cast (Pitfall 4)
- No hardcoded strings — all visible text via `t()` calls
- `max-w-7xl mx-auto` on the filter+grid container — prevents cards from stretching too wide on 1440px displays
  </action>
  <verify>
1. npx tsc --noEmit from /Users/mohamedkhair/Coding/lumiere-beaute exits with code 0
2. grep "Phase 2 stub" src/pages/ServicesPage.tsx returns no results
3. npm run build succeeds
  </verify>
  <done>ServicesPage.tsx is replaced with full implementation: page hero, CategoryTabs wired to activeCategory state, TreatmentGrid receiving filteredTreatments; Phase 2 stub text removed; zero TypeScript errors; production build succeeds</done>
</task>

</tasks>

<verification>
- src/components/sections/CategoryTabs.tsx exists, exports CategoryTabs, contains LayoutGroup and layoutId
- src/components/sections/TreatmentGrid.tsx exists, exports TreatmentGrid, contains AnimatePresence mode="popLayout"
- src/pages/ServicesPage.tsx has useState for activeCategory, computes filteredTreatments
- grep "Phase 2 stub" src/pages/ServicesPage.tsx returns empty
- grep "from.*motion/react" src/components/sections/CategoryTabs.tsx src/components/sections/TreatmentGrid.tsx src/pages/ServicesPage.tsx returns empty (all import from 'framer-motion')
- npx tsc --noEmit and npm run build both exit code 0
</verification>

<success_criteria>
Services page is fully functional: CategoryTabs renders 5 category tabs with animated underline, TreatmentGrid renders filtered cards with AnimatePresence entry/exit, all 20 treatments are accessible across tabs, and zero TypeScript errors.
</success_criteria>

<output>
After completion, create `.planning/phases/04-homepage-and-services/04-05-SUMMARY.md`
</output>
