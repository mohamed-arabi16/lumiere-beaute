---
phase: 06-content-and-qa
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.ts
  - tests/rtl-snapshots/rtl-homepage.spec.ts
  - tests/rtl-snapshots/rtl-services.spec.ts
  - tests/rtl-snapshots/rtl-academy.spec.ts
  - tests/rtl-snapshots/rtl-contact.spec.ts
  - tests/rtl-snapshots/rtl-nav.spec.ts
  - .github/workflows/rtl-snapshots.yml
  - package.json
autonomous: true
requirements:
  - FNDTN-04

must_haves:
  truths:
    - "Running 'npx playwright test' locally executes RTL snapshot tests for all 5 pages at both 390px and 1440px"
    - "Each test sets localStorage('i18nextLng', 'ar') before navigation so the app loads in Arabic+RTL"
    - "Each test waits for html[dir='rtl'] before taking the snapshot — timing guaranteed"
    - "Baseline snapshots are generated and committed so CI can compare against them"
    - "GitHub Actions workflow runs Playwright RTL tests on push to main"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright config with webServer pointing to vite dev server at 5173, chromium project, maxDiffPixels: 100"
    - path: "tests/rtl-snapshots/rtl-homepage.spec.ts"
      provides: "RTL snapshot tests for homepage at 390px and 1440px"
    - path: ".github/workflows/rtl-snapshots.yml"
      provides: "CI workflow that installs Playwright, generates/compares snapshots on push"
  key_links:
    - from: "tests/rtl-snapshots/*.spec.ts"
      to: "localStorage i18nextLng"
      via: "page.addInitScript"
      pattern: "localStorage.setItem\\('i18nextLng', 'ar'\\)"
    - from: "tests/rtl-snapshots/*.spec.ts"
      to: "html[dir='rtl']"
      via: "page.waitForSelector"
      pattern: "waitForSelector.*html\\[dir.*rtl"
    - from: ".github/workflows/rtl-snapshots.yml"
      to: "npx playwright test"
      via: "GitHub Actions step"
      pattern: "playwright test"
---

<objective>
Install Playwright, write RTL snapshot tests for all five pages at mobile and desktop viewports, and create a GitHub Actions CI workflow that runs them on push to main.

Purpose: FNDTN-04 requires that Arabic RTL layout is verifiably correct — Playwright visual snapshots are the locked CONTEXT.md approach (not manual walkthrough). CI integration prevents RTL regressions from re-entering the codebase after merge.

Output: playwright.config.ts, 5 spec files in tests/rtl-snapshots/, a .github/workflows/rtl-snapshots.yml CI workflow, and baseline snapshot images generated by running the tests once.
</objective>

<execution_context>
@/Users/mohamedkhair/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mohamedkhair/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-content-and-qa/06-CONTEXT.md
@.planning/phases/06-content-and-qa/06-RESEARCH.md
@src/i18n/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and write RTL snapshot spec files</name>
  <files>
    playwright.config.ts
    tests/rtl-snapshots/rtl-homepage.spec.ts
    tests/rtl-snapshots/rtl-services.spec.ts
    tests/rtl-snapshots/rtl-academy.spec.ts
    tests/rtl-snapshots/rtl-contact.spec.ts
    tests/rtl-snapshots/rtl-nav.spec.ts
    package.json
  </files>
  <action>
**Step 1 — Install Playwright.**

```bash
npm install --save-dev @playwright/test
npx playwright install chromium
```

Do NOT run `npm init playwright@latest` — this overwrites existing config files. Install the package directly then write config manually.

**Step 2 — Create `playwright.config.ts` at project root.**

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },
  // Snapshot tolerance — Arabic font rendering differs between macOS and Linux CI
  expect: {
    toHaveScreenshot: { maxDiffPixels: 100 },
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
    timeout: 120_000,
  },
});
```

**Step 3 — Create RTL helper shared setup.**

Create `tests/rtl-snapshots/rtl-homepage.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('RTL layout — Homepage', () => {
  test.beforeEach(async ({ page }) => {
    // Set Arabic locale — matches i18next lookupLocalStorage key in src/i18n/config.ts
    await page.addInitScript(() => {
      localStorage.setItem('i18nextLng', 'ar');
    });
  });

  test('homepage RTL at 390px mobile', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto('/');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('homepage-rtl-390.png');
  });

  test('homepage RTL at 1440px desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1440, height: 900 });
    await page.goto('/');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('homepage-rtl-1440.png');
  });
});
```

Create `tests/rtl-snapshots/rtl-services.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('RTL layout — Services', () => {
  test.beforeEach(async ({ page }) => {
    await page.addInitScript(() => {
      localStorage.setItem('i18nextLng', 'ar');
    });
  });

  test('services RTL at 390px mobile', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto('/services');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('services-rtl-390.png');
  });

  test('services RTL at 1440px desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1440, height: 900 });
    await page.goto('/services');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('services-rtl-1440.png');
  });
});
```

Create `tests/rtl-snapshots/rtl-academy.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('RTL layout — Academy', () => {
  test.beforeEach(async ({ page }) => {
    await page.addInitScript(() => {
      localStorage.setItem('i18nextLng', 'ar');
    });
  });

  test('academy RTL at 390px mobile', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto('/academy');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('academy-rtl-390.png');
  });

  test('academy RTL at 1440px desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1440, height: 900 });
    await page.goto('/academy');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('academy-rtl-1440.png');
  });
});
```

Create `tests/rtl-snapshots/rtl-contact.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';

test.describe('RTL layout — Contact', () => {
  test.beforeEach(async ({ page }) => {
    await page.addInitScript(() => {
      localStorage.setItem('i18nextLng', 'ar');
    });
  });

  test('contact RTL at 390px mobile', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto('/contact');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('contact-rtl-390.png');
  });

  test('contact RTL at 1440px desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1440, height: 900 });
    await page.goto('/contact');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    await expect(page).toHaveScreenshot('contact-rtl-1440.png');
  });
});
```

Create `tests/rtl-snapshots/rtl-nav.spec.ts` — tests navigation components in RTL (navbar items order, mobile menu):

```typescript
import { test, expect } from '@playwright/test';

test.describe('RTL layout — Navigation', () => {
  test.beforeEach(async ({ page }) => {
    await page.addInitScript(() => {
      localStorage.setItem('i18nextLng', 'ar');
    });
  });

  test('navbar RTL at 1440px desktop', async ({ page }) => {
    await page.setViewportSize({ width: 1440, height: 900 });
    await page.goto('/');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    // Capture just the navbar for a focused layout check
    const navbar = await page.locator('header').first();
    await expect(navbar).toHaveScreenshot('navbar-rtl-1440.png');
  });

  test('mobile menu RTL at 390px', async ({ page }) => {
    await page.setViewportSize({ width: 390, height: 844 });
    await page.goto('/');
    await page.waitForSelector('html[dir="rtl"]', { timeout: 5000 });
    // Open the mobile menu before capturing
    const hamburger = await page.locator('button[aria-label]').first();
    await hamburger.click();
    await page.waitForTimeout(400); // Allow AnimatePresence animation to complete
    await expect(page).toHaveScreenshot('mobile-menu-rtl-390.png');
  });
});
```

**Step 4 — Generate baseline snapshots.**

After creating all spec files, run Playwright in update mode to generate the baseline PNG files:

```bash
npx playwright test --update-snapshots
```

This creates the snapshot images that subsequent CI runs compare against. If the dev server fails to start automatically, start it manually in a separate terminal first:
```bash
npm run dev &
npx playwright test --update-snapshots
```

Baseline images will be created in `tests/rtl-snapshots/rtl-snapshots.spec.ts-snapshots/` directories next to each spec file (Playwright puts them in `{spec-name}-snapshots/` next to the spec file).
  </action>
  <verify>
    <automated>test -f playwright.config.ts && test -f tests/rtl-snapshots/rtl-homepage.spec.ts && test -f tests/rtl-snapshots/rtl-services.spec.ts && test -f tests/rtl-snapshots/rtl-academy.spec.ts && test -f tests/rtl-snapshots/rtl-contact.spec.ts && test -f tests/rtl-snapshots/rtl-nav.spec.ts && npx playwright test --list 2>&1 | grep "rtl"</automated>
    <manual>npx playwright test — all tests should pass (or update baselines if first run). Check that snapshot PNG files have been created in tests/rtl-snapshots/ subdirectories.</manual>
  </verify>
  <done>playwright.config.ts exists. 5 spec files exist. @playwright/test is in devDependencies. Running 'npx playwright test --list' lists all 12 RTL tests (2 per spec × 5 specs + 2 nav tests). Baseline snapshot PNGs have been generated.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow for RTL snapshots</name>
  <files>
    .github/workflows/rtl-snapshots.yml
  </files>
  <action>
Create the `.github/workflows/` directory structure and write the workflow file.

Create `.github/workflows/rtl-snapshots.yml`:

```yaml
name: RTL Snapshot Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  rtl-snapshots:
    name: Playwright RTL Layout Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run RTL snapshot tests
        run: npx playwright test
        env:
          CI: true

      - name: Upload test report on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload snapshots on failure (for diff inspection)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: failed-snapshots
          path: tests/
          retention-days: 7
```

**Important notes for the executor:**
- This workflow runs on ubuntu-latest. Because Arabic font rendering differs between macOS (local) and Linux (CI), the CI run may fail the first time with pixel difference errors even for correct layouts.
- If CI fails purely due to font rendering (not actual layout bugs), regenerate baselines on Linux:
  - Option A: Commit the workflow, wait for CI to run, download the generated snapshots from the CI artifact, and commit those as the new baseline.
  - Option B: Add `--update-snapshots` to the CI run command on the first run only (one-time baseline generation), then remove the flag and re-commit.
- The `maxDiffPixels: 100` tolerance in playwright.config.ts provides buffer for minor font rendering differences.
- Document this font-rendering gotcha in the SUMMARY for future reference.
  </action>
  <verify>
    <automated>test -f .github/workflows/rtl-snapshots.yml && grep "npx playwright test" .github/workflows/rtl-snapshots.yml && grep "ubuntu-latest" .github/workflows/rtl-snapshots.yml</automated>
    <manual>Open .github/workflows/rtl-snapshots.yml in editor — confirm it has push/pull_request triggers on main, installs Playwright browsers, and runs 'npx playwright test'.</manual>
  </verify>
  <done>.github/workflows/rtl-snapshots.yml exists and is syntactically valid YAML. Triggers on push and PR to main. Installs Playwright browsers with deps. Uploads playwright-report artifact on failure.</done>
</task>

</tasks>

<verification>
1. `test -f playwright.config.ts` — exists at project root
2. `ls tests/rtl-snapshots/*.spec.ts | wc -l` — must show 5 spec files
3. `npx playwright test --list` — must list all RTL tests without errors
4. `npx playwright test` — must pass (or succeed with snapshot generation on first run)
5. `test -f .github/workflows/rtl-snapshots.yml` — CI workflow exists
6. `grep "i18nextLng" tests/rtl-snapshots/rtl-homepage.spec.ts` — localStorage key must match app's detection key
</verification>

<success_criteria>
- Playwright installed as devDependency with chromium browser available
- playwright.config.ts configures webServer for localhost:5173, maxDiffPixels: 100 globally
- 5 spec files cover all pages (homepage, services, academy, contact, nav) at 390px and 1440px in RTL
- Every test uses addInitScript to set localStorage i18nextLng='ar' before navigation
- Every test calls waitForSelector('html[dir="rtl"]') before taking screenshot
- Baseline snapshot PNG files generated and present in the tests/ directory tree
- GitHub Actions workflow file triggers on push/PR to main and runs 'npx playwright test'
- Font rendering CI vs macOS difference documented in SUMMARY with resolution approach
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-and-qa/06-02-SUMMARY.md`
</output>
