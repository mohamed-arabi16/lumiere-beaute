---
phase: 06-content-and-qa
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/components/sections/HeroSection.tsx
  - src/components/sections/StatsSection.tsx
  - src/components/sections/CategoryTabs.tsx
  - src/components/sections/TreatmentGrid.tsx
  - src/components/sections/CoursesSection.tsx
  - src/components/sections/TestimonialsSection.tsx
  - src/components/sections/AcademyTeaserSection.tsx
  - src/components/sections/ServicesTeaserSection.tsx
  - src/pages/ServicesPage.tsx
  - src/pages/AcademyPage.tsx
  - src/pages/HomePage.tsx
  - vite.config.js
autonomous: true
requirements:
  - FNDTN-03
  - FNDTN-04

must_haves:
  truths:
    - "Lighthouse mobile performance score is 75 or higher on all 5 pages"
    - "If score is below 75, React.lazy() + Suspense applied to page-level components to defer bundle loading"
    - "If score still below 75 after lazy loading, animation-heavy sections are disabled on mobile via useMediaQuery('(max-width: 768px)')"
    - "All five pages load without layout shifts visible in Lighthouse CLS report"
  artifacts:
    - path: "vite.config.js"
      provides: "Vite build config with chunk splitting if applied for bundle optimization"
    - path: "src/pages/HomePage.tsx"
      provides: "React.lazy-wrapped page component if lazy loading remediation was applied"
  key_links:
    - from: "Lighthouse audit command"
      to: "npm run build && npm run preview"
      via: "lighthouse CLI against production build at localhost:4173"
      pattern: "lighthouse.*localhost:4173"
---

<objective>
Run Lighthouse mobile performance audits against a production build on all five pages, and remediate any page scoring below 75. The hard gate: all 5 pages must reach 75 before this plan completes.

Purpose: CONTEXT.md locked decision — "Lighthouse mobile score of 75 is a hard gate." This plan validates the site is production-performant. Research identified the primary risk is Framer Motion JS bundle weight (not images — site uses CSS gradients only). Remediation path: first try React.lazy() for page-level code splitting, then disable animations on mobile if needed.

Output: Lighthouse JSON reports for all 5 pages, plus any performance remediation applied to reach 75 on every page.
</objective>

<execution_context>
@/Users/mohamedkhair/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mohamedkhair/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-content-and-qa/06-CONTEXT.md
@.planning/phases/06-content-and-qa/06-RESEARCH.md
@vite.config.js
@src/pages/HomePage.tsx
@src/pages/ServicesPage.tsx
@src/pages/AcademyPage.tsx
@src/pages/ContactPage.tsx
@src/pages/AboutPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run Lighthouse audits on all 5 pages (production build)</name>
  <files>
    lighthouse-home.json
    lighthouse-services.json
    lighthouse-academy.json
    lighthouse-contact.json
    lighthouse-about.json
  </files>
  <action>
**CRITICAL: Always audit against the production build, not the dev server.** Dev server includes source maps, HMR runtime, and unminified assets — scores will be 20-40 points lower than production.

**Step 1 — Install Lighthouse CLI (global, one-time).**
```bash
npm install -g lighthouse
```

**Step 2 — Build production bundle.**
```bash
npm run build
```
Vite will output to `dist/`. Fix any TypeScript errors before proceeding.

**Step 3 — Start preview server (production build).**
```bash
npm run preview &
```
The preview server starts on `http://localhost:4173` by default.

**Step 4 — Run Lighthouse on each page.**

Run each audit separately to get individual JSON reports. The `--form-factor=mobile` flag simulates a Moto G4-class device (Lighthouse standard for mobile audits):

```bash
npx lighthouse http://localhost:4173 \
  --only-categories=performance \
  --form-factor=mobile \
  --screenEmulation.mobile=true \
  --output=json \
  --output-path=./lighthouse-home.json \
  --chrome-flags="--headless"

npx lighthouse http://localhost:4173/services \
  --only-categories=performance \
  --form-factor=mobile \
  --screenEmulation.mobile=true \
  --output=json \
  --output-path=./lighthouse-services.json \
  --chrome-flags="--headless"

npx lighthouse http://localhost:4173/academy \
  --only-categories=performance \
  --form-factor=mobile \
  --screenEmulation.mobile=true \
  --output=json \
  --output-path=./lighthouse-academy.json \
  --chrome-flags="--headless"

npx lighthouse http://localhost:4173/contact \
  --only-categories=performance \
  --form-factor=mobile \
  --screenEmulation.mobile=true \
  --output=json \
  --output-path=./lighthouse-contact.json \
  --chrome-flags="--headless"

npx lighthouse http://localhost:4173/about \
  --only-categories=performance \
  --form-factor=mobile \
  --screenEmulation.mobile=true \
  --output=json \
  --output-path=./lighthouse-about.json \
  --chrome-flags="--headless"
```

**Step 5 — Extract scores from JSON reports.**

```bash
node -e "
  const pages = ['home', 'services', 'academy', 'contact', 'about'];
  pages.forEach(p => {
    try {
      const r = require('./lighthouse-' + p + '.json');
      const score = Math.round(r.categories.performance.score * 100);
      console.log(p + ':', score, score >= 75 ? 'PASS' : 'FAIL');
    } catch(e) { console.log(p + ': ERROR', e.message); }
  });
"
```

**Step 6 — Document results.** Record each page's score in the task action output. Note which pages (if any) scored below 75 for Task 2 remediation.

Kill the preview server after audits:
```bash
pkill -f "vite preview" || true
```
  </action>
  <verify>
    <automated>test -f lighthouse-home.json && test -f lighthouse-services.json && test -f lighthouse-academy.json && test -f lighthouse-contact.json && test -f lighthouse-about.json && node -e "const r=require('./lighthouse-home.json'); process.exit(r.categories.performance.score >= 0.75 ? 0 : 1)"</automated>
    <manual>Check each JSON report. Look at 'categories.performance.score' (multiply × 100 for the 0-100 score). All must be ≥ 75. If any fail, proceed to Task 2 remediation.</manual>
  </verify>
  <done>Five Lighthouse JSON report files exist. Scores recorded for all 5 pages. Pages scoring below 75 identified for Task 2 remediation (or Task 2 skipped if all pass).</done>
</task>

<task type="auto">
  <name>Task 2: Remediate pages scoring below 75 (apply in order until 75 reached)</name>
  <files>
    src/pages/HomePage.tsx
    src/pages/ServicesPage.tsx
    src/pages/AcademyPage.tsx
    src/pages/ContactPage.tsx
    src/pages/AboutPage.tsx
    src/App.tsx
    vite.config.js
  </files>
  <action>
**Only execute this task if Task 1 revealed any page scoring below 75.**

Apply remediations in this specific order — stop when all pages reach 75. Re-run the Lighthouse audit after each remediation to confirm improvement.

---

**Remediation Level 1 — React.lazy() page-level code splitting**

This is the primary lever for Framer Motion bundle weight. Each page import currently loads all page code synchronously. Switching to lazy imports lets Vite split each page into a separate chunk, deferring Framer Motion component loading until the route is active.

In `src/App.tsx` (or the router file — check where page components are imported), replace static imports:

```typescript
// BEFORE (static — all loaded upfront)
import { HomePage } from './pages/HomePage';
import { ServicesPage } from './pages/ServicesPage';
import { AcademyPage } from './pages/AcademyPage';
import { ContactPage } from './pages/ContactPage';
import { AboutPage } from './pages/AboutPage';
```

With lazy imports wrapped in Suspense:

```typescript
// AFTER (lazy — each page is a separate chunk)
import { lazy, Suspense } from 'react';
const HomePage = lazy(() => import('./pages/HomePage').then(m => ({ default: m.HomePage })));
const ServicesPage = lazy(() => import('./pages/ServicesPage').then(m => ({ default: m.ServicesPage })));
const AcademyPage = lazy(() => import('./pages/AcademyPage').then(m => ({ default: m.AcademyPage })));
const ContactPage = lazy(() => import('./pages/ContactPage').then(m => ({ default: m.ContactPage })));
const AboutPage = lazy(() => import('./pages/AboutPage').then(m => ({ default: m.AboutPage })));
```

Wrap the router outlet in a Suspense boundary. Find the `<AnimatedOutlet />` or `<Outlet />` in RootLayout and add:

```typescript
<Suspense fallback={<div className="min-h-screen bg-surface-ivory dark:bg-surface-dark" />}>
  <AnimatedOutlet />
</Suspense>
```

The fallback div uses the same surface colors as the app backgrounds — prevents a white flash during chunk loading.

Re-run Lighthouse after this change. If all pages are now ≥ 75, stop here.

---

**Remediation Level 2 — Disable animations on mobile (if Level 1 insufficient)**

This reduces Framer Motion execution time on the Lighthouse-simulated Moto G4 device. The `MotionConfig` in `AppProviders` already respects `reducedMotion: 'user'`. The additional step is to disable the most JS-intensive animations specifically on mobile viewports.

In section components with heavy animations (StatsSection animated counters, TreatmentGrid AnimatePresence, TestimonialsSection), add a mobile guard:

```typescript
import { useMediaQuery } from '../hooks/useMediaQuery'; // create this hook if not present
const isMobile = useMediaQuery('(max-width: 768px)');
```

If `useMediaQuery` hook does not exist, create `src/hooks/useMediaQuery.ts`:

```typescript
import { useState, useEffect } from 'react';

export function useMediaQuery(query: string): boolean {
  const [matches, setMatches] = useState(() => window.matchMedia(query).matches);
  useEffect(() => {
    const mq = window.matchMedia(query);
    const handler = (e: MediaQueryListEvent) => setMatches(e.matches);
    mq.addEventListener('change', handler);
    return () => mq.removeEventListener('change', handler);
  }, [query]);
  return matches;
}
```

In StatsSection, wrap the animated counter with a mobile check — render static numbers on mobile:
```typescript
const isMobile = useMediaQuery('(max-width: 768px)');
// ...
{isMobile ? (
  <span>{stat.value.toLocaleString()}</span>
) : (
  <StatCounter value={stat.value} />
)}
```

Re-run Lighthouse after applying to all heavy-animation components. Record the new scores.

---

**Remediation Level 3 — Vite manual chunk splitting (if Levels 1 and 2 insufficient)**

Add manual chunks to `vite.config.js` to ensure Framer Motion is in a separate vendor chunk:

```javascript
// In vite.config.js build.rollupOptions:
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        'vendor-framer': ['framer-motion'],
        'vendor-react': ['react', 'react-dom'],
        'vendor-router': ['react-router-dom'],
        'vendor-i18n': ['react-i18next', 'i18next'],
      },
    },
  },
},
```

Rebuild and re-run Lighthouse. This reduces the main bundle size by extracting large vendor libraries into separately-cacheable chunks.

---

**After each remediation level:** Run `npm run build` to confirm no TypeScript errors, then re-run the Lighthouse CLI commands from Task 1. Record the new scores. Phase 6 is blocked until all 5 pages reach ≥ 75.
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -5</automated>
    <manual>Re-run Lighthouse for any previously-failing pages. Confirm all 5 pages now score ≥ 75. Record final scores in SUMMARY.</manual>
  </verify>
  <done>All 5 pages score ≥ 75 on Lighthouse mobile. Final scores recorded. Any remediations applied are documented in SUMMARY with before/after scores. npm run build produces zero errors.</done>
</task>

</tasks>

<verification>
1. `npm run build` — zero TypeScript errors
2. All five lighthouse-*.json files exist and contain performance scores
3. `node -e "['home','services','academy','contact','about'].forEach(p=>{ const r=require('./lighthouse-'+p+'.json'); const s=Math.round(r.categories.performance.score*100); console.log(p,s,s>=75?'PASS':'FAIL') })"` — all must show PASS
4. If remediations applied: `grep -n "lazy\|Suspense" src/App.tsx` — must match if lazy loading was applied
</verification>

<success_criteria>
- Lighthouse mobile performance score ≥ 75 on ALL five pages: /, /services, /academy, /contact, /about
- Audits run against npm run build + npm run preview (production build, not dev server)
- All five lighthouse-*.json report files exist for documentation
- If lazy loading applied: React.lazy() wraps all 5 page imports, Suspense boundary wraps AnimatedOutlet in RootLayout
- If mobile animation disable applied: useMediaQuery hook exists, StatsSection and other heavy-animation components render static fallbacks on mobile
- npm run build completes without TypeScript errors after any remediations
- Final scores for all 5 pages documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-and-qa/06-03-SUMMARY.md`
</output>
